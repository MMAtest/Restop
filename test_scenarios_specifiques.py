#!/usr/bin/env python3
"""
Tests sp√©cifiques selon la demande de review:
- Test des mod√®les Fournisseur mis √† jour
- Cr√©ation fournisseur avec couleur et logo
- Modification fournisseur existant pour ajouter couleur et logo
- V√©rifications sp√©cifiques demand√©es
"""

import requests
import json
from datetime import datetime

# Configuration
BASE_URL = "https://restop-manager.preview.emergentagent.com/api"
HEADERS = {"Content-Type": "application/json"}

class TestScenariosSpecifiques:
    def __init__(self):
        self.test_results = []
        self.created_ids = []
        
    def log_result(self, test_name, success, message="", details=None):
        """Enregistre le r√©sultat d'un test"""
        result = {
            "test": test_name,
            "success": success,
            "message": message,
            "details": details,
            "timestamp": datetime.now().isoformat()
        }
        self.test_results.append(result)
        status = "‚úÖ" if success else "‚ùå"
        print(f"{status} {test_name}: {message}")
        if details and not success:
            print(f"   D√©tails: {details}")
    
    def test_scenario_1_boucherie_martin(self):
        """Test cr√©ation Boucherie Martin selon sp√©cifications exactes"""
        print("\n=== SC√âNARIO 1: BOUCHERIE MARTIN ===")
        
        fournisseur_data = {
            "nom": "Boucherie Martin",
            "email": "contact@boucherie-martin.fr", 
            "telephone": "01.23.45.67.89",
            "couleur": "#DC2626",
            "logo": "ü•©"
        }
        
        try:
            response = requests.post(f"{BASE_URL}/fournisseurs", json=fournisseur_data, headers=HEADERS)
            if response.status_code == 200:
                created = response.json()
                self.created_ids.append(created["id"])
                
                # V√©rifications sp√©cifiques
                checks = [
                    (created.get("nom") == "Boucherie Martin", "Nom correct"),
                    (created.get("email") == "contact@boucherie-martin.fr", "Email correct"),
                    (created.get("telephone") == "01.23.45.67.89", "T√©l√©phone correct"),
                    (created.get("couleur") == "#DC2626", "Couleur rouge correcte"),
                    (created.get("logo") == "ü•©", "Logo viande correct"),
                    ("id" in created, "ID g√©n√©r√©"),
                    ("created_at" in created, "Date cr√©ation pr√©sente")
                ]
                
                all_passed = all(check[0] for check in checks)
                failed_checks = [check[1] for check in checks if not check[0]]
                
                if all_passed:
                    self.log_result("POST /api/fournisseurs avec nouveaux champs accept√©", True, 
                                  "Boucherie Martin cr√©√©e avec tous les champs corrects")
                else:
                    self.log_result("POST /api/fournisseurs avec nouveaux champs accept√©", False, 
                                  f"√âchecs: {', '.join(failed_checks)}")
            else:
                self.log_result("POST /api/fournisseurs avec nouveaux champs accept√©", False, 
                              f"Erreur HTTP {response.status_code}: {response.text}")
        except Exception as e:
            self.log_result("POST /api/fournisseurs avec nouveaux champs accept√©", False, 
                          f"Exception: {str(e)}")
    
    def test_scenario_2_poissonnerie_ocean(self):
        """Test cr√©ation Poissonnerie Oc√©an avec logo URL"""
        print("\n=== SC√âNARIO 2: POISSONNERIE OC√âAN ===")
        
        fournisseur_data = {
            "nom": "Poissonnerie Oc√©an",
            "email": "contact@poissonnerie-ocean.fr",
            "couleur": "#0284C7", 
            "logo": "üêü"
        }
        
        try:
            response = requests.post(f"{BASE_URL}/fournisseurs", json=fournisseur_data, headers=HEADERS)
            if response.status_code == 200:
                created = response.json()
                self.created_ids.append(created["id"])
                
                # V√©rifications sp√©cifiques
                if (created.get("couleur") == "#0284C7" and created.get("logo") == "üêü"):
                    self.log_result("Cr√©ation fournisseur avec logo URL", True, 
                                  "Poissonnerie Oc√©an cr√©√©e avec couleur bleue et logo poisson")
                else:
                    self.log_result("Cr√©ation fournisseur avec logo URL", False, 
                                  f"Couleur: {created.get('couleur')}, Logo: {created.get('logo')}")
            else:
                self.log_result("Cr√©ation fournisseur avec logo URL", False, 
                              f"Erreur HTTP {response.status_code}")
        except Exception as e:
            self.log_result("Cr√©ation fournisseur avec logo URL", False, f"Exception: {str(e)}")
    
    def test_verification_get_fournisseurs_retourne_champs(self):
        """V√©rification: GET /api/fournisseurs retourne les champs couleur et logo"""
        print("\n=== V√âRIFICATION: GET RETOURNE COULEUR ET LOGO ===")
        
        try:
            response = requests.get(f"{BASE_URL}/fournisseurs")
            if response.status_code == 200:
                fournisseurs = response.json()
                
                if len(fournisseurs) > 0:
                    # V√©rifier que tous les fournisseurs ont les champs
                    fournisseurs_avec_champs = [f for f in fournisseurs 
                                              if "couleur" in f and "logo" in f]
                    
                    if len(fournisseurs_avec_champs) == len(fournisseurs):
                        self.log_result("GET /api/fournisseurs retourne les champs couleur et logo", True, 
                                      f"Tous les {len(fournisseurs)} fournisseurs ont couleur et logo")
                        
                        # V√©rifier nos fournisseurs de test sp√©cifiquement
                        boucherie = next((f for f in fournisseurs if f["nom"] == "Boucherie Martin"), None)
                        poissonnerie = next((f for f in fournisseurs if f["nom"] == "Poissonnerie Oc√©an"), None)
                        
                        if boucherie and boucherie.get("couleur") == "#DC2626":
                            self.log_result("Boucherie Martin dans GET", True, "Couleur rouge pr√©sente")
                        else:
                            self.log_result("Boucherie Martin dans GET", False, "Couleur incorrecte ou absente")
                        
                        if poissonnerie and poissonnerie.get("logo") == "üêü":
                            self.log_result("Poissonnerie Oc√©an dans GET", True, "Logo poisson pr√©sent")
                        else:
                            self.log_result("Poissonnerie Oc√©an dans GET", False, "Logo incorrect ou absent")
                    else:
                        self.log_result("GET /api/fournisseurs retourne les champs couleur et logo", False, 
                                      f"Seulement {len(fournisseurs_avec_champs)}/{len(fournisseurs)} avec champs")
                else:
                    self.log_result("GET /api/fournisseurs retourne les champs couleur et logo", False, 
                                  "Aucun fournisseur trouv√©")
            else:
                self.log_result("GET /api/fournisseurs retourne les champs couleur et logo", False, 
                              f"Erreur HTTP {response.status_code}")
        except Exception as e:
            self.log_result("GET /api/fournisseurs retourne les champs couleur et logo", False, 
                          f"Exception: {str(e)}")
    
    def test_verification_put_fournisseurs_modification(self):
        """V√©rification: PUT /api/fournisseurs pour modifier couleur/logo fonctionne"""
        print("\n=== V√âRIFICATION: PUT MODIFICATION COULEUR/LOGO ===")
        
        if not self.created_ids:
            self.log_result("PUT /api/fournisseurs pour modifier couleur/logo fonctionne", False, 
                          "Aucun fournisseur cr√©√© pour le test")
            return
        
        # Modifier le premier fournisseur cr√©√©
        fournisseur_id = self.created_ids[0]
        
        modification_data = {
            "nom": "Boucherie Martin Modifi√©e",
            "email": "contact@boucherie-martin.fr",
            "telephone": "01.23.45.67.89",
            "couleur": "#EF4444",  # Rouge plus clair
            "logo": "ü•ì"  # Bacon au lieu de viande
        }
        
        try:
            response = requests.put(f"{BASE_URL}/fournisseurs/{fournisseur_id}", 
                                  json=modification_data, headers=HEADERS)
            if response.status_code == 200:
                modified = response.json()
                
                if (modified.get("couleur") == "#EF4444" and modified.get("logo") == "ü•ì"):
                    self.log_result("PUT /api/fournisseurs pour modifier couleur/logo fonctionne", True, 
                                  "Modification couleur et logo r√©ussie")
                else:
                    self.log_result("PUT /api/fournisseurs pour modifier couleur/logo fonctionne", False, 
                                  f"Modification √©chou√©e - couleur: {modified.get('couleur')}, logo: {modified.get('logo')}")
            else:
                self.log_result("PUT /api/fournisseurs pour modifier couleur/logo fonctionne", False, 
                              f"Erreur HTTP {response.status_code}")
        except Exception as e:
            self.log_result("PUT /api/fournisseurs pour modifier couleur/logo fonctionne", False, 
                          f"Exception: {str(e)}")
    
    def test_verification_valeurs_defaut(self):
        """V√©rification: Valeurs par d√©faut correctes (couleur: #3B82F6, logo: null)"""
        print("\n=== V√âRIFICATION: VALEURS PAR D√âFAUT ===")
        
        # Cr√©er un fournisseur sans couleur ni logo
        fournisseur_minimal = {
            "nom": "Fournisseur Test D√©faut",
            "email": "test@defaut.fr"
        }
        
        try:
            response = requests.post(f"{BASE_URL}/fournisseurs", json=fournisseur_minimal, headers=HEADERS)
            if response.status_code == 200:
                created = response.json()
                self.created_ids.append(created["id"])
                
                couleur_defaut = created.get("couleur")
                logo_defaut = created.get("logo")
                
                if couleur_defaut == "#3B82F6":
                    self.log_result("Valeurs par d√©faut correctes (couleur: #3B82F6, logo: null)", True, 
                                  f"Couleur par d√©faut correcte: {couleur_defaut}")
                else:
                    self.log_result("Valeurs par d√©faut correctes (couleur: #3B82F6, logo: null)", False, 
                                  f"Couleur par d√©faut incorrecte: {couleur_defaut}")
                
                if logo_defaut is None:
                    self.log_result("Logo par d√©faut null", True, "Logo par d√©faut correct: null")
                else:
                    self.log_result("Logo par d√©faut null", False, f"Logo par d√©faut incorrect: {logo_defaut}")
            else:
                self.log_result("Valeurs par d√©faut correctes (couleur: #3B82F6, logo: null)", False, 
                              f"Erreur HTTP {response.status_code}")
        except Exception as e:
            self.log_result("Valeurs par d√©faut correctes (couleur: #3B82F6, logo: null)", False, 
                          f"Exception: {str(e)}")
    
    def test_verification_validation_format_couleur_hex(self):
        """V√©rification: Validation des formats couleur hex"""
        print("\n=== V√âRIFICATION: VALIDATION FORMAT COULEUR HEX ===")
        
        # Test avec diff√©rents formats de couleur
        test_cases = [
            ("#FFFFFF", "Blanc hex majuscules"),
            ("#000000", "Noir hex"),
            ("#ff5733", "Orange hex minuscules"),
            ("#F0F", "Format court hex"),
            ("rgb(255,0,0)", "Format RGB (peut √™tre accept√© ou rejet√©)"),
            ("blue", "Nom de couleur (peut √™tre accept√© ou rejet√©)")
        ]
        
        for couleur, description in test_cases:
            fournisseur_test = {
                "nom": f"Test {description}",
                "email": f"test-{couleur.replace('#', '').replace('(', '').replace(')', '').replace(',', '-')}@test.fr",
                "couleur": couleur
            }
            
            try:
                response = requests.post(f"{BASE_URL}/fournisseurs", json=fournisseur_test, headers=HEADERS)
                if response.status_code == 200:
                    created = response.json()
                    self.created_ids.append(created["id"])
                    couleur_result = created.get("couleur")
                    
                    if couleur.startswith("#") and len(couleur) in [4, 7]:  # Format hex valide
                        if couleur_result == couleur or couleur_result == couleur.upper():
                            self.log_result(f"Validation format couleur hex - {description}", True, 
                                          f"Format hex accept√©: {couleur_result}")
                        else:
                            self.log_result(f"Validation format couleur hex - {description}", False, 
                                          f"Format hex modifi√©: {couleur} -> {couleur_result}")
                    else:  # Format non-hex
                        self.log_result(f"Validation format couleur - {description}", True, 
                                      f"Format accept√©/converti: {couleur} -> {couleur_result}")
                else:
                    self.log_result(f"Validation format couleur - {description}", True, 
                                  f"Format rejet√© (HTTP {response.status_code})")
            except Exception as e:
                self.log_result(f"Validation format couleur - {description}", False, 
                              f"Exception: {str(e)}")
    
    def test_verification_structure_json_conforme(self):
        """V√©rification: Structure JSON conforme"""
        print("\n=== V√âRIFICATION: STRUCTURE JSON CONFORME ===")
        
        try:
            response = requests.get(f"{BASE_URL}/fournisseurs")
            if response.status_code == 200:
                fournisseurs = response.json()
                
                if len(fournisseurs) > 0:
                    sample = fournisseurs[0]
                    
                    # Champs requis de base
                    required_fields = ["id", "nom", "created_at"]
                    # Nouveaux champs
                    new_fields = ["couleur", "logo"]
                    # Champs optionnels
                    optional_fields = ["email", "telephone", "contact", "adresse"]
                    
                    all_required = all(field in sample for field in required_fields)
                    all_new = all(field in sample for field in new_fields)
                    
                    if all_required and all_new:
                        self.log_result("Structure JSON conforme", True, 
                                      "Tous les champs requis et nouveaux pr√©sents")
                        
                        # V√©rifier les types
                        type_checks = [
                            (isinstance(sample.get("couleur"), str), "couleur est string"),
                            (sample.get("logo") is None or isinstance(sample.get("logo"), str), "logo est string ou null"),
                            (isinstance(sample.get("id"), str), "id est string"),
                            (isinstance(sample.get("nom"), str), "nom est string")
                        ]
                        
                        all_types_ok = all(check[0] for check in type_checks)
                        if all_types_ok:
                            self.log_result("Types de donn√©es corrects", True, "Tous les types sont corrects")
                        else:
                            failed_types = [check[1] for check in type_checks if not check[0]]
                            self.log_result("Types de donn√©es corrects", False, 
                                          f"Types incorrects: {', '.join(failed_types)}")
                    else:
                        missing = []
                        if not all_required:
                            missing.extend([f for f in required_fields if f not in sample])
                        if not all_new:
                            missing.extend([f for f in new_fields if f not in sample])
                        
                        self.log_result("Structure JSON conforme", False, 
                                      f"Champs manquants: {', '.join(missing)}")
                else:
                    self.log_result("Structure JSON conforme", False, "Aucun fournisseur pour v√©rifier la structure")
            else:
                self.log_result("Structure JSON conforme", False, f"Erreur HTTP {response.status_code}")
        except Exception as e:
            self.log_result("Structure JSON conforme", False, f"Exception: {str(e)}")
    
    def run_all_tests(self):
        """Ex√©cute tous les tests sp√©cifiques"""
        print("üéØ TESTS SP√âCIFIQUES SELON DEMANDE DE REVIEW")
        print("=" * 60)
        
        # Tests des sc√©narios sp√©cifiques
        self.test_scenario_1_boucherie_martin()
        self.test_scenario_2_poissonnerie_ocean()
        
        # V√©rifications demand√©es
        self.test_verification_get_fournisseurs_retourne_champs()
        self.test_verification_put_fournisseurs_modification()
        self.test_verification_valeurs_defaut()
        self.test_verification_validation_format_couleur_hex()
        self.test_verification_structure_json_conforme()
        
        # R√©sum√©
        print("\n" + "=" * 60)
        print("üìä R√âSUM√â DES V√âRIFICATIONS SP√âCIFIQUES")
        print("=" * 60)
        
        total_tests = len(self.test_results)
        passed_tests = len([r for r in self.test_results if r["success"]])
        failed_tests = total_tests - passed_tests
        
        print(f"Total: {total_tests} v√©rifications")
        print(f"‚úÖ R√©ussies: {passed_tests}")
        print(f"‚ùå √âchou√©es: {failed_tests}")
        print(f"üìà Taux de r√©ussite: {(passed_tests/total_tests)*100:.1f}%")
        
        # D√©tail des √©checs
        if failed_tests > 0:
            print("\n‚ùå V√âRIFICATIONS √âCHOU√âES:")
            for result in self.test_results:
                if not result["success"]:
                    print(f"  - {result['test']}: {result['message']}")
        
        return passed_tests, failed_tests

if __name__ == "__main__":
    test_suite = TestScenariosSpecifiques()
    passed, failed = test_suite.run_all_tests()
    
    if failed == 0:
        print("\nüéâ TOUTES LES V√âRIFICATIONS SONT PASS√âES!")
        print("‚úÖ Les am√©liorations visuelles des fournisseurs avec codes couleur et logos fonctionnent parfaitement!")
    else:
        print(f"\n‚ö†Ô∏è {failed} v√©rification(s) ont √©chou√©")